
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/imagens/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/css/publicacao.css">
    <link rel="stylesheet" href="/css/share-button.css">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

    <title>Publicação</title>
</head>
<body>

   <% if (tipo_usuario === 'profissional') { %>
      <%- include('../partials/menu-logado', { tipo_usuario: tipo_usuario }) %>
   <% } else if (tipo_usuario === 'comum') { %>
      <%- include('../partials/menu-c-c', { tipo_usuario: tipo_usuario }) %>
   <% } else { %>
      <%- include('../partials/menu', { tipo_usuario: tipo_usuario }) %>
   <% } %>

   <main>
       <!-- Seu conteúdo principal aqui -->
       
       <div id="comentarios-lista">
           <!-- Comentários aparecerão aqui -->
       </div>

       <% if (usuario) { %>
           <textarea id="ad-comentario" rows="3" placeholder="Digite seu comentário"></textarea><br>
           <button id="btn-enviar-comentario">Enviar Comentário</button>
       <% } else { %>
           <p>Faça login para comentar.</p>
       <% } %>

       <!-- Resto do seu conteúdo -->

   </main>

   <%- include('../partials/rodape'); %>

   <!-- Seus outros scripts -->
   <script src="/js/like.js"></script>
   <script src="/js/voltar.js"></script>
   <script src="/js/expan-img.js"></script>
   <script src="/js/mobile-navbar.js"></script>
   <script src="/js/denuncia-compartilhamento.js"></script>
   <script src="/js/publicacoesindex.js"></script>

   <!-- Script para carregar e enviar comentários -->
   <script>
      // Variáveis definidas com dados do backend
      const idPublicacao = "<%= publicacao.ID_PUBLICACAO %>";
const idUsuario = "<%= usuario ? usuario.ID_USUARIO : '' %>";


      function carregarComentarios(idPublicacao) {
          fetch(`/comentarios/${idPublicacao}`)
          .then(res => res.json())
          .then(comentarios => {
              const lista = document.getElementById('comentarios-lista');
              if (!lista) return;
              lista.innerHTML = '';
              if (comentarios.length === 0) {
                  lista.innerHTML = '<p>Nenhum comentário ainda.</p>';
                  return;
              }
              comentarios.forEach(c => {
                  lista.innerHTML += `
                  <section class="comentario">
                      <section class="comentario-info">
                          <img src="${c.FOTO_PERFIL_PASTA_USUARIO || '/imagens/fotoperfil1.jpeg'}" class="foto-de-perfil" >
                          <a href="/perfil/${c.ID_USUARIO}">
                              <p class="nome-comentario">${c.NOME_USUARIO || 'Usuário'}</p>
                          </a>
                      </section>
                      <section class="escrita-comentario">
                          <p>${c.CONTEUDO_COMENTARIO}</p>
                          <small>${new Date(c.DATA_COMENTARIO).toLocaleString()}</small>
                      </section>
                  </section>
                  `;
              });
          })
          .catch(() => {
              const lista = document.getElementById('comentarios-lista');
              if (lista) lista.innerHTML = '<p style="color:red">Erro ao carregar comentários.</p>';
          });
      }

      function enviarComentario() {
          const textarea = document.getElementById('ad-comentario');
          const texto = textarea.value.trim();
          if (!texto) return alert('Digite um comentário.');

          fetch(`/comentarios/${idPublicacao}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ texto, id_usuario: idUsuario, id_publicacao: idPublicacao })
          })
          .then(res => res.json())
          .then(comentarios => {
              textarea.value = '';
              const lista = document.getElementById('comentarios-lista');
              if (!lista) return;
              lista.innerHTML = '';
              if (comentarios.length === 0) {
                  lista.innerHTML = '<p style="color:red">Nenhum comentário retornado.</p>';
                  return;
              }
              comentarios.forEach(c => {
                  lista.innerHTML += `
                  <section class="comentario">
                      <section class="comentario-info">
                          <img src="${c.FOTO_PERFIL_PASTA_USUARIO || '/imagens/fotoperfil1.jpeg'}" class="foto-de-perfil" >
                          <a href="/perfil/${c.ID_USUARIO}">
                              <p class="nome-comentario">${c.NOME_USUARIO || 'Usuário'}</p>
                          </a>
                      </section>
                      <section class="escrita-comentario">
                          <p>${c.CONTEUDO_COMENTARIO}</p>
                          <small>${new Date(c.DATA_COMENTARIO).toLocaleString()}</small>
                      </section>
                  </section>
                  `;
              });
          })
          .catch(() => {
              const lista = document.getElementById('comentarios-lista');
              if (lista) lista.innerHTML = '<p style="color:red">Erro ao enviar comentário.</p>';
          });
      }

      document.addEventListener('DOMContentLoaded', () => {
          carregarComentarios(idPublicacao);
          const btnEnviar = document.getElementById('btn-enviar-comentario');
          if (btnEnviar) btnEnviar.addEventListener('click', enviarComentario);
      });
   </script>

</body>
</html>
